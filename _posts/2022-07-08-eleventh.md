---
layout: single
title: "PL/SQL Programming 기록"
---
<br><br>

PL/SQL의 제어문, Exception(예외처리), Cursor(커서)를 정리하고자 한다.

<br><br>
___


# 제어문

## IF문

if문의 구조는 아래와 같다.
```
IF 조건 THEN
    문장1;
    ...
[ELSIF 조건 THEN
    문장2;
    ...

    ...
ELSE [조건 THEN]
    문장n;
]
END IF;
```
이때, 여러 개의 ELSIF절은 쓸 수 있지만 ELSE절은 한 번만 사용이 가능하다.
조건에 맞으면 THEN 이하의 문장을 실행, 계속 안맞으면 아래로 내려감. 어느 경우에나 END IF 다음의 문장으로 넘어감.

## LOOP 문
### 일반 LOOP문 
LOOP문의 구조는 다음과 같다.
```
BASIC LOOP문

LOOP
    문장들;
    ...
    EXIT [WHEN 조건]
END LOOP;
```
EXIT는 (무한 루프)를 탈출하는 역할을 수행, 조건에 따라 LOOP를 탈출할 수 있도록 WHEN절을 기술한다.
<BR><BR>

### FOR LOOP문
EXIT절이 없는 루프문으로 FOR ~ LOOP문이 존재한다.
```
FOR 인덱스 IN [REVERSE] 하한 ... 상한 LOOP
    문장들;
    ...
END LOOP;
```
1. FOR LOOP에서 인덱스는 정수로 자동 선언되고, 상한에 도달할 때까지 1씩 증가
2. REVERSE를 추가하면 1씩 감소
3. 증감치를 따로 지정할 수는 없다. 증감치를 따로 지정하고 싶다면 위의 일반 LOOP문을 이용하거나, 아래의 WHILE LOOP문을 이용해야 한다.

### WHILE LOOP문
다른 언어에서 사용하는 제어문 WHILE과 유사하다.

```
WHILE 조건 LOOP
    문장들;
END LOOP;
```
제어조건이 TRUE인 경우에만 문장을 반복한다. 처음 시작부터 조건이 FALSE이면 LOOP를 실행하지 않는다.
<BR><BR>

_____

# Exception
- Exception은 PL/SQL에서 발생하는 에러로, 각각 자신만의 Error Message를 가진다.
- 일반적으로 Oracle Server가 에러를 판단하여 Exception을 발생시키는 경우가 다반사이나, 사용자가 블록에서 'RAISE'문을 사용하여 명시적으로 Exception을 발생시킬 수 있다.

## Exception 처리 구문

```
EXCEPTION
    WHEN exception_name [exception_names ...] THEN
        문장들;
    [WHEN .... THEN ...]
    ...
    [WHEN OTHERS THEN ...] -- ELSE와 비슷한 형태
    ...
```
WHEN OTHERS 구문은 EXCEPTION 처리의 마지막 구문으로, 미리 선언되지 못한 모든 경우의 예외 처리를 수행한다.

이제 exception_name을 파악해야 한다.
### Case of Exception
1. Predefined Exception
    - 오라클이 미리 정의해둔 Exception.
    - 다음과 같은 Exception이 존재한다.
    
    |Exception_Name|설명|
    |--|--|
    |NO_DATA_FOUND|데이터를 반환하지 못한 SELECT문|
    |TOO_MANY_ROWS|두 개 이상을 반환한 SELECT문|
    |INVALID_CURSOR|잘못된 CURSOR 연산 발생|
    |ZERO_DIVIDE|0으로 나누기|
    |DUP_VAL_ON_INDEX|UNIQUE COLUMN에 중복된 값을 입력할 때|
    |CURSOR_ALREADY_OPEN|이미 열려있는 커서를 여는 경우|
    |INVALID_NUMBER|문자열을 숫자로 전환하지 못한 경우|
    |LOGIN_DENIED|유효하지 않은 사용자로 LOG-ON 시도|
    |NOT_LOGGED_ON|PL/SQL 프로그램이 오라클에 연결되지 않은 상태서 호출|
    |PROGRAM_ERROR|PL/SQL 내부에 오류|
    |STORAGE_ERROR|PL/SQL 메모리 부족|
    |TIMEOUT_ON_RESOURCE|오라클이 자원을 기다리는 동안 시간 초과 발생|
    |VALUE_ERROR|산술, 절단 등에서 크기가 다른 오류 발생|

<br><br>

2. Non-Predefined Exception
    - 사용자가 DECLARE 섹션에서 Exception 이름을 정의하고, Error 번호를 사용해 Error와 연결, 이후 Exception에서 예외처리를 진행한다.
    ```
    DECLARE
        exception_name EXCEPTION;
        PRAGMA EXCEPTION_INIT(exception이름, 에러번호);
    BEGIN
        ...
    EXCEPTION
        WHEN exception_name THEN (이럴 때 exception이라 할거에요)
        ...
    END;    
    ```

    - Exception을 정의하는 예시를 보면서 파악해보자
    ```
    CREATE OR REPLACE PROCEDURE def_product
    (  v_id IN s_product.id%TYPE  )
    IS
        fk_error EXCEPTION
        PRAGMA EXCEPTION_INIT(fk_error, -2292)
    BEGIN
        DELETE FROM s_product
        WHERE id = v_id
        COMMIT;
    EXCEPTION
        WHEN fk_error THEN
            ROLLBACK;
            DBMS_OUTPUT.PUT_LINE('참조되는 레코드가 있으므로 삭제 불가');
    END;
    /
    ```
    - 위의 '-2292'는 'ORA-02292'로, 데이터 삭제할 때 참조 무결성 위반이 발생하면 나타나는 에러번호이다.
    - 정확하게는, Exception에 별명을 붙인다고 생각하면 된다.
    
    <BR><BR>

3. User Defined EXCEPTION
    - 오라클 서버가 판단하는 에러가 아닌, 사용자가 정의한 조건이 만족되지 않을 때 에러를 발생시키는 방법이다.
    - DECLARE 섹션에서 EXCEPTION 이름을 정의하고, BEGIN 섹션에서 RAISE문을 사용해 에러를 발생시킨다.

    구조는 아래와 같다.
    ```
    DECLARE
        exception_name EXCEPTION;
    BEGIN
        RAISE exception_name;
        ...
    EXCEPTION
        WHEN exception_name THEN
        ...
    END;
    ```
    
    












